<UserControl x:Class="AssetProcessor.Controls.ORMPackingPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:core="clr-namespace:AssetProcessor.TextureConversion.Core"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="350"
             Background="{DynamicResource ThemeBackground}">

    <UserControl.Resources>
        <ObjectDataProvider x:Key="CompressionFormatValues" MethodName="GetValues" ObjectType="{x:Type core:CompressionFormat}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:CompressionFormat"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="FilterTypeValues" MethodName="GetValues" ObjectType="{x:Type core:FilterType}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:FilterType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="ToksvigCalculationModeValues" MethodName="GetValues" ObjectType="{x:Type core:ToksvigCalculationMode}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:ToksvigCalculationMode"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <!-- Use global compact styles, only define local aliases for compatibility -->
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="3">
            <TextBlock Text="ORM Channel Packing" FontSize="12" FontWeight="Bold" Margin="0,0,0,2"/>

            <!-- Packing Mode -->
            <GroupBox Header="Mode" Style="{StaticResource CompactGroupBoxStyle}">
                <ComboBox x:Name="PackingModeComboBox" Style="{StaticResource CompactComboBoxStyle}"
                          SelectionChanged="PackingModeComboBox_SelectionChanged">
                    <ComboBoxItem Content="OG (RGB=AO, A=Gloss)" Tag="OG"/>
                    <ComboBoxItem Content="OGM (R=AO, G=Gloss, B=Metallic)" Tag="OGM" IsSelected="True"/>
                    <ComboBoxItem Content="OGMH (R=AO, G=Gloss, B=Metallic, A=Height)" Tag="OGMH"/>
                </ComboBox>
            </GroupBox>

            <!-- AO Channel -->
            <GroupBox Header="AO Channel" Style="{StaticResource CompactGroupBoxStyle}">
                <StackPanel>
                    <TextBlock Text="Source:" Style="{StaticResource CompactLabelStyle}"/>
                    <ComboBox x:Name="AOSourceComboBox" Style="{StaticResource CompactComboBoxStyle}"
                              DisplayMemberPath="Name" SelectionChanged="SourceComboBox_SelectionChanged"/>

                    <TextBlock Text="Mip Filter:" Style="{StaticResource CompactLabelStyle}"/>
                    <ComboBox x:Name="AOFilterTypeComboBox" Style="{StaticResource CompactComboBoxStyle}"
                              ItemsSource="{Binding Source={StaticResource FilterTypeValues}}"/>

                    <TextBlock Text="Processing:" Style="{StaticResource CompactLabelStyle}"/>
                    <ComboBox x:Name="AOProcessingComboBox" Style="{StaticResource CompactComboBoxStyle}"
                              SelectionChanged="AOProcessing_Changed">
                        <ComboBoxItem Content="None" Tag="None" IsSelected="True"/>
                        <ComboBoxItem Content="Biased Darkening" Tag="BiasedDarkening"/>
                        <ComboBoxItem Content="Percentile" Tag="Percentile"/>
                    </ComboBox>

                    <StackPanel x:Name="AOBiasPanel" Visibility="Collapsed" Margin="0,1,0,0">
                        <TextBlock Text="Bias:" Style="{StaticResource CompactLabelStyle}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="AOBiasSlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                    Minimum="0.1" Maximum="1.0" Value="0.5" TickFrequency="0.1" IsSnapToTickEnabled="False"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=AOBiasSlider, Path=Value, StringFormat={}{0:F2}}"
                                      Style="{StaticResource CompactLabelStyle}" Width="28" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>

                    <StackPanel x:Name="AOPercentilePanel" Visibility="Collapsed" Margin="0,1,0,0">
                        <TextBlock Text="Percentile:" Style="{StaticResource CompactLabelStyle}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="AOPercentileSlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                    Minimum="1" Maximum="50" Value="10" TickFrequency="1" IsSnapToTickEnabled="False"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=AOPercentileSlider, Path=Value, StringFormat={}{0:F1}%}"
                                      Style="{StaticResource CompactLabelStyle}" Width="35" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </GroupBox>

            <!-- Gloss Channel -->
            <GroupBox Header="Gloss Channel" Style="{StaticResource CompactGroupBoxStyle}">
                <StackPanel>
                    <TextBlock Text="Source:" Style="{StaticResource CompactLabelStyle}"/>
                    <ComboBox x:Name="GlossSourceComboBox" Style="{StaticResource CompactComboBoxStyle}"
                              DisplayMemberPath="Name" SelectionChanged="SourceComboBox_SelectionChanged"/>

                    <TextBlock Text="Mip Filter:" Style="{StaticResource CompactLabelStyle}"/>
                    <ComboBox x:Name="GlossFilterTypeComboBox" Style="{StaticResource CompactComboBoxStyle}"
                              ItemsSource="{Binding Source={StaticResource FilterTypeValues}}"/>

                    <TextBlock Text="Processing:" Style="{StaticResource CompactLabelStyle}"/>
                    <CheckBox x:Name="GlossToksvigCheckBox" Content="Toksvig Anti-Aliasing"
                              Style="{StaticResource CompactCheckBoxStyle}" IsChecked="True"
                              Checked="GlossToksvig_Changed" Unchecked="GlossToksvig_Changed"/>

                    <StackPanel x:Name="GlossToksvigPanel" Visibility="Visible">
                        <ComboBox x:Name="ToksvigCalculationModeComboBox" Style="{StaticResource CompactComboBoxStyle}"
                                  ItemsSource="{Binding Source={StaticResource ToksvigCalculationModeValues}}"/>

                        <TextBlock Text="Power:" Style="{StaticResource CompactLabelStyle}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="GlossToksvigPowerSlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                    Minimum="0.5" Maximum="8" Value="4.0" TickFrequency="0.1" IsSnapToTickEnabled="False"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=GlossToksvigPowerSlider, Path=Value, StringFormat={}{0:F1}}"
                                      Style="{StaticResource CompactLabelStyle}" Width="28" TextAlignment="Right"/>
                        </Grid>

                        <TextBlock Text="Min Mip:" Style="{StaticResource CompactLabelStyle}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ToksvigMinMipLevelSlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                    Minimum="0" Maximum="5" Value="0" TickFrequency="1" IsSnapToTickEnabled="True"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ToksvigMinMipLevelSlider, Path=Value, StringFormat={}{0:F0}}"
                                      Style="{StaticResource CompactLabelStyle}" Width="28" TextAlignment="Right"/>
                        </Grid>

                        <CheckBox x:Name="ToksvigEnergyPreservingCheckBox" Content="Energy-Preserving"
                                  Style="{StaticResource CompactCheckBoxStyle}" IsChecked="True"/>
                        <CheckBox x:Name="ToksvigSmoothVarianceCheckBox" Content="Smooth Variance"
                                  Style="{StaticResource CompactCheckBoxStyle}" IsChecked="True"/>
                    </StackPanel>
                </StackPanel>
            </GroupBox>

            <!-- Metallic Channel -->
            <StackPanel x:Name="MetallicPanel">
                <GroupBox Header="Metallic Channel" Style="{StaticResource CompactGroupBoxStyle}">
                    <StackPanel>
                        <TextBlock Text="Source:" Style="{StaticResource CompactLabelStyle}"/>
                        <ComboBox x:Name="MetallicSourceComboBox" Style="{StaticResource CompactComboBoxStyle}"
                                  DisplayMemberPath="Name" SelectionChanged="SourceComboBox_SelectionChanged"/>

                        <TextBlock Text="Mip Filter:" Style="{StaticResource CompactLabelStyle}"/>
                        <ComboBox x:Name="MetallicFilterTypeComboBox" Style="{StaticResource CompactComboBoxStyle}"
                                  ItemsSource="{Binding Source={StaticResource FilterTypeValues}}"/>

                        <TextBlock Text="Processing:" Style="{StaticResource CompactLabelStyle}"/>
                        <ComboBox x:Name="MetallicProcessingModeComboBox" Style="{StaticResource CompactComboBoxStyle}"
                                  SelectionChanged="MetallicProcessingModeComboBox_SelectionChanged">
                            <ComboBoxItem Content="None" Tag="None" IsSelected="True"/>
                            <ComboBoxItem Content="Biased Darkening" Tag="BiasedDarkening"/>
                            <ComboBoxItem Content="Percentile" Tag="Percentile"/>
                        </ComboBox>

                        <StackPanel x:Name="MetallicBiasPanel" Visibility="Collapsed">
                            <TextBlock Text="Bias:" Style="{StaticResource CompactLabelStyle}"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="MetallicBiasSlider" Grid.Column="0" Minimum="0.0" Maximum="1.0" Value="0.5"
                                        TickFrequency="0.1" IsSnapToTickEnabled="False" Style="{StaticResource CompactSliderStyle}"/>
                                <TextBlock Grid.Column="1" Text="{Binding ElementName=MetallicBiasSlider, Path=Value, StringFormat={}{0:F2}}"
                                          Style="{StaticResource CompactLabelStyle}" Width="28" TextAlignment="Right"/>
                            </Grid>
                        </StackPanel>

                        <StackPanel x:Name="MetallicPercentilePanel" Visibility="Collapsed">
                            <TextBlock Text="Percentile:" Style="{StaticResource CompactLabelStyle}"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="MetallicPercentileSlider" Grid.Column="0" Minimum="0.0" Maximum="50.0" Value="10.0"
                                        TickFrequency="1.0" IsSnapToTickEnabled="False" Style="{StaticResource CompactSliderStyle}"/>
                                <TextBlock Grid.Column="1" Text="{Binding ElementName=MetallicPercentileSlider, Path=Value, StringFormat={}{0:F1}%}"
                                          Style="{StaticResource CompactLabelStyle}" Width="35" TextAlignment="Right"/>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </GroupBox>
            </StackPanel>

            <!-- Height Channel -->
            <StackPanel x:Name="HeightPanel" Visibility="Collapsed">
                <GroupBox Header="Height Channel" Style="{StaticResource CompactGroupBoxStyle}">
                    <StackPanel>
                        <TextBlock Text="Source:" Style="{StaticResource CompactLabelStyle}"/>
                        <ComboBox x:Name="HeightSourceComboBox" Style="{StaticResource CompactComboBoxStyle}"
                                  DisplayMemberPath="Name" SelectionChanged="SourceComboBox_SelectionChanged"/>

                        <TextBlock Text="Processing: None" Style="{StaticResource CompactLabelStyle}" Foreground="Gray"/>
                    </StackPanel>
                </GroupBox>
            </StackPanel>

            <!-- Compression -->
            <GroupBox Header="Compression" Style="{StaticResource CompactGroupBoxStyle}">
                <StackPanel>
                    <ComboBox x:Name="CompressionFormatComboBox" Style="{StaticResource CompactComboBoxStyle}"
                              ItemsSource="{Binding Source={StaticResource CompressionFormatValues}}"
                              SelectionChanged="CompressionFormat_Changed"/>

                    <!-- ETC1S -->
                    <StackPanel x:Name="ETC1SPanel">
                        <TextBlock Text="Compress Level:" Style="{StaticResource CompactLabelStyle}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="CompressLevelSlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                    Minimum="0" Maximum="5" Value="1" TickFrequency="1" IsSnapToTickEnabled="True"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=CompressLevelSlider, Path=Value, StringFormat={}{0:F0}}"
                                      Style="{StaticResource CompactLabelStyle}" Width="28" TextAlignment="Right"/>
                        </Grid>

                        <TextBlock Text="Quality:" Style="{StaticResource CompactLabelStyle}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="QualityLevelSlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                    Minimum="1" Maximum="255" Value="128" TickFrequency="1" IsSnapToTickEnabled="True"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=QualityLevelSlider, Path=Value, StringFormat={}{0:F0}}"
                                      Style="{StaticResource CompactLabelStyle}" Width="28" TextAlignment="Right"/>
                        </Grid>

                        <CheckBox x:Name="PerceptualCheckBox" Content="Perceptual" Style="{StaticResource CompactCheckBoxStyle}"/>
                    </StackPanel>

                    <!-- UASTC -->
                    <StackPanel x:Name="UASTCPanel" Visibility="Collapsed">
                        <TextBlock Text="Quality:" Style="{StaticResource CompactLabelStyle}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="UASTCQualitySlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                    Minimum="0" Maximum="4" Value="2" TickFrequency="1" IsSnapToTickEnabled="True"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=UASTCQualitySlider, Path=Value, StringFormat={}{0:F0}}"
                                      Style="{StaticResource CompactLabelStyle}" Width="28" TextAlignment="Right"/>
                        </Grid>

                        <CheckBox x:Name="EnableRDOCheckBox" Content="RDO" Style="{StaticResource CompactCheckBoxStyle}"
                                  Checked="EnableRDO_Changed" Unchecked="EnableRDO_Changed"/>
                        <StackPanel x:Name="RDOPanel" Visibility="Collapsed">
                            <TextBlock Text="Lambda:" Style="{StaticResource CompactLabelStyle}"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="RDOLambdaSlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                        Minimum="0.001" Maximum="10.0" Value="1.0" IsSnapToTickEnabled="False"/>
                                <TextBlock Grid.Column="1" Text="{Binding ElementName=RDOLambdaSlider, Path=Value, StringFormat={}{0:F3}}"
                                          Style="{StaticResource CompactLabelStyle}" Width="35" TextAlignment="Right"/>
                            </Grid>
                        </StackPanel>

                        <CheckBox x:Name="EnableSupercompressionCheckBox" Content="Supercompression (Zstd)"
                                  Style="{StaticResource CompactCheckBoxStyle}"
                                  Checked="EnableSupercompression_Changed" Unchecked="EnableSupercompression_Changed"/>
                        <StackPanel x:Name="SupercompressionPanel" Visibility="Collapsed">
                            <TextBlock Text="Level:" Style="{StaticResource CompactLabelStyle}"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="SupercompressionLevelSlider" Grid.Column="0" Style="{StaticResource CompactSliderStyle}"
                                        Minimum="1" Maximum="22" Value="3" TickFrequency="1" IsSnapToTickEnabled="True"/>
                                <TextBlock Grid.Column="1" Text="{Binding ElementName=SupercompressionLevelSlider, Path=Value, StringFormat={}{0:F0}}"
                                          Style="{StaticResource CompactLabelStyle}" Width="28" TextAlignment="Right"/>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </GroupBox>

            <!-- Status -->
            <GroupBox Header="Status" Style="{StaticResource CompactGroupBoxStyle}">
                <StackPanel>
                    <TextBlock x:Name="StatusText" Text="Ready" Style="{StaticResource CompactLabelStyle}"/>
                    <TextBlock x:Name="MissingChannelsText" Text="" Style="{StaticResource CompactLabelStyle}" Foreground="Orange"/>
                </StackPanel>
            </GroupBox>

            <!-- Pack Button -->
            <Button x:Name="PackConvertButton" Content="Pack &amp; Convert to KTX2"
                    Click="PackConvert_Click" Height="24" FontSize="10" FontWeight="Bold"
                    Background="#FF4CAF50" Foreground="White" Margin="0,2,0,0"/>
        </StackPanel>
    </ScrollViewer>
</UserControl>
