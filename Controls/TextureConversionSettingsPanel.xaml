<UserControl x:Class="AssetProcessor.Controls.TextureConversionSettingsPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:core="clr-namespace:AssetProcessor.TextureConversion.Core"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="280">

    <UserControl.Resources>
        <!-- Enum Data Providers -->
        <ObjectDataProvider x:Key="CompressionFormatValues" MethodName="GetValues" ObjectType="{x:Type core:CompressionFormat}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:CompressionFormat"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="OutputFormatValues" MethodName="GetValues" ObjectType="{x:Type core:OutputFormat}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:OutputFormat"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="FilterTypeValues" MethodName="GetValues" ObjectType="{x:Type core:FilterType}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:FilterType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="KTX2SupercompressionValues" MethodName="GetValues" ObjectType="{x:Type core:KTX2SupercompressionType}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:KTX2SupercompressionType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="ToksvigCalculationModeValues" MethodName="GetValues" ObjectType="{x:Type core:ToksvigCalculationMode}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:ToksvigCalculationMode"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="ColorSpaceValues" MethodName="GetValues" ObjectType="{x:Type core:ColorSpace}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:ColorSpace"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="ToktxFilterTypeValues" MethodName="GetValues" ObjectType="{x:Type core:ToktxFilterType}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:ToktxFilterType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="WrapModeValues" MethodName="GetValues" ObjectType="{x:Type core:WrapMode}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:WrapMode"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="HistogramModeValues" MethodName="GetValues" ObjectType="{x:Type core:HistogramMode}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:HistogramMode"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="HistogramChannelModeValues" MethodName="GetValues" ObjectType="{x:Type core:HistogramChannelMode}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:HistogramChannelMode"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <!-- HistogramProcessingMode Ð¸ HistogramQuantization ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ (Ð²ÑÐµÐ³Ð´Ð° Preprocessing + Half16) -->

        <!-- Compact Expander Style -->
        <Style x:Key="CompactExpanderStyle" TargetType="Expander">
            <Setter Property="Margin" Value="0,0,0,1"/>
            <Setter Property="BorderBrush" Value="#BDC3C7"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HeaderTemplate">
                <Setter.Value>
                    <DataTemplate>
                        <TextBlock Text="{Binding}" FontWeight="SemiBold" FontSize="9" Margin="0,1"/>
                    </DataTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Compact GroupBox Style -->
        <Style x:Key="CompactGroupBoxStyle" TargetType="GroupBox">
            <Setter Property="Margin" Value="0,0,0,1"/>
            <Setter Property="Padding" Value="1"/>
            <Setter Property="BorderBrush" Value="#BDC3C7"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="9"/>
        </Style>

        <!-- ComboBox Style -->
        <Style x:Key="ReadableComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Background" Value="#F5F5F5"/>
            <Setter Property="Foreground" Value="#2C3E50"/>
            <Setter Property="BorderBrush" Value="#BDC3C7"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="3,1"/>
            <Setter Property="FontSize" Value="9"/>
        </Style>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#2C3E50"/>
            <Setter Property="Padding" Value="3,1"/>
            <Setter Property="FontSize" Value="9"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#E3F2FD"/>
                    <Setter Property="Foreground" Value="#0D47A1"/>
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#BBDEFB"/>
                    <Setter Property="Foreground" Value="#0D47A1"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Label Style -->
        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="Margin" Value="0,0,0,1"/>
        </Style>

        <!-- Checkbox Style -->
        <Style TargetType="CheckBox">
            <Setter Property="FontSize" Value="9"/>
        </Style>

        <!-- Button Style -->
        <Style TargetType="Button">
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="Padding" Value="3,1"/>
        </Style>
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <StackPanel Margin="1">

            <!-- 1. PRESET SECTION -->
            <GroupBox Header="Preset" Style="{StaticResource CompactGroupBoxStyle}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <ComboBox x:Name="PresetComboBox" Grid.Column="0" Margin="0,0,5,0"
                              Style="{StaticResource ReadableComboBoxStyle}"
                              SelectionChanged="PresetComboBox_SelectionChanged"
                              ToolTip="Select compression preset"/>
                    <Button Content="ðŸ”" Grid.Column="1" Width="30" Margin="0,0,2,0"
                            Click="AutoDetectPreset_Click"
                            ToolTip="Auto-detect preset by filename"/>
                    <Button Content="..." Grid.Column="2" Width="30"
                            Click="ManagePresets_Click"
                            ToolTip="Manage presets"/>
                </Grid>
            </GroupBox>

            <!-- 2. COMPRESSION SETTINGS SECTION -->
            <Expander Header="Compression Settings" Style="{StaticResource CompactExpanderStyle}" IsExpanded="True">
                <StackPanel Margin="2,1,0,0">
                    <!-- Compression Format + Output Format (on one row) -->
                    <Grid Margin="0,0,0,3">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="2"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Compression:" Style="{StaticResource LabelStyle}"/>
                            <ComboBox x:Name="CompressionFormatComboBox"
                                      Style="{StaticResource ReadableComboBoxStyle}"
                                      ItemsSource="{Binding Source={StaticResource CompressionFormatValues}}"
                                      SelectionChanged="CompressionFormatComboBox_SelectionChanged"/>
                        </StackPanel>
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Output:" Style="{StaticResource LabelStyle}"/>
                            <ComboBox x:Name="OutputFormatComboBox"
                                      Style="{StaticResource ReadableComboBoxStyle}"
                                      ItemsSource="{Binding Source={StaticResource OutputFormatValues}}"
                                      SelectionChanged="OutputFormatComboBox_SelectionChanged"
                                      ToolTip="KTX2 (recommended, GPU compressed), Basis (legacy), or PNG (uncompressed)"/>
                        </StackPanel>
                    </Grid>

                    <!-- Compression Level (ETC1S only) -->
                    <StackPanel x:Name="CompressionLevelPanel" Visibility="Collapsed">
                        <TextBlock Text="Compression Level (0-5):" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="CompressionLevelSlider" Grid.Column="0"
                                    Minimum="0" Maximum="5" Value="1"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"
                                    ToolTip="0=fastest, 5=slowest/best"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=CompressionLevelSlider, Path=Value}"
                                       Width="25" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>

                    <!-- Quality (ETC1S) -->
                    <StackPanel x:Name="ETC1SQualityPanel" Visibility="Collapsed">
                        <TextBlock Text="Quality (1-255):" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ETC1SQualitySlider" Grid.Column="0"
                                    Minimum="1" Maximum="255" Value="128"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ETC1SQualitySlider, Path=Value}"
                                       Width="25" TextAlignment="Right"/>
                        </Grid>
                        <CheckBox x:Name="UseETC1SRDOCheckBox" Content="RDO Optimizer" Margin="0,0,0,2"
                                  IsChecked="True"
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"/>
                    </StackPanel>

                    <!-- Quality (UASTC) -->
                    <StackPanel x:Name="UASTCQualityPanel" Visibility="Collapsed">
                        <TextBlock Text="UASTC Quality (0-4):" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="UASTCQualitySlider" Grid.Column="0"
                                    Minimum="0" Maximum="4" Value="2"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=UASTCQualitySlider, Path=Value}"
                                       Width="25" TextAlignment="Right"/>
                        </Grid>
                        <CheckBox x:Name="UseUASTCRDOCheckBox" Content="Use RDO" Margin="0,0,0,1" IsChecked="True"
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                                  ToolTip="Use Rate-Distortion Optimization for better quality/size ratio"/>
                        <TextBlock Text="RDO Lambda (0.001-10):" Style="{StaticResource LabelStyle}"
                                   IsEnabled="{Binding ElementName=UseUASTCRDOCheckBox, Path=IsChecked}"
                                   ToolTip="Recommended: 0.25-10 for general textures, 0.25-0.75 for normal maps"/>
                        <Grid Margin="0,0,0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="UASTCRDOLambdaSlider" Grid.Column="0" Minimum="0.001" Maximum="10" Value="1"
                                    TickFrequency="0.001" IsSnapToTickEnabled="False" Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"
                                    IsEnabled="{Binding ElementName=UseUASTCRDOCheckBox, Path=IsChecked}"
                                    ToolTip="Lower = higher quality/larger files. Higher = lower quality/smaller files."/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=UASTCRDOLambdaSlider, Path=Value, StringFormat={}{0:F3}}"
                                       Width="40" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>

                    <CheckBox x:Name="PerceptualModeCheckBox" Content="Perceptual Mode" Margin="0,0,0,2" IsChecked="True"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="Visual quality improvement (ETC1S/ASTC only)"/>

                    <!-- Color Space (OETF) -->
                    <TextBlock Text="Color Space (OETF):" Style="{StaticResource LabelStyle}"/>
                    <ComboBox x:Name="ColorSpaceComboBox"
                              Style="{StaticResource ReadableComboBoxStyle}"
                              ItemsSource="{Binding Source={StaticResource ColorSpaceValues}}"
                              SelectionChanged="ComboBoxSettingChanged"
                              Margin="0,0,0,2"
                              ToolTip="Color space (--assign_oetf): Auto (detect from file metadata), Linear (normals, roughness, metallic), or sRGB (albedo, emissive)"/>

                    <!-- KTX2 Supercompression -->
                    <StackPanel x:Name="KTX2SupercompressionPanel" Visibility="Collapsed">
                        <TextBlock Text="KTX2 Supercompression:" Style="{StaticResource LabelStyle}"/>
                        <ComboBox x:Name="KTX2SupercompressionComboBox"
                                  Style="{StaticResource ReadableComboBoxStyle}"
                                  ItemsSource="{Binding Source={StaticResource KTX2SupercompressionValues}}"
                                  SelectionChanged="KTX2SupercompressionComboBox_SelectionChanged"
                                  Margin="0,0,0,2"
                                  ToolTip="Additional compression for KTX2: Zstandard (best), ZLIB (compatible), or None"/>

                        <TextBlock Text="Supercompression Level (1-22):" Style="{StaticResource LabelStyle}"
                                   ToolTip="Zstandard compression level. Only for UASTC format. Higher = smaller files but slower. Not available for ETC1S."/>
                        <Grid Margin="0,0,0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ZstdLevelSlider" Grid.Column="0"
                                    Minimum="1" Maximum="22" Value="3"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"
                                    ToolTip="Zstandard level (default 3). Only for UASTC! Values >20 require more memory."/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ZstdLevelSlider, Path=Value}"
                                       Width="25" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- 3. ALPHA OPTIONS SECTION -->
            <Expander Header="Alpha Options" Style="{StaticResource CompactExpanderStyle}" IsExpanded="False">
                <StackPanel Margin="2,1,0,0">
                    <CheckBox x:Name="ForceAlphaCheckBox" Content="Force Alpha Channel" Margin="0,0,0,1"
                              Checked="ForceAlphaCheckBox_Checked" Unchecked="CheckboxSettingChanged"
                              ToolTip="Add alpha channel (--target_type RGBA)"/>
                    <CheckBox x:Name="RemoveAlphaCheckBox" Content="Remove Alpha Channel" Margin="0,0,0,1"
                              Checked="RemoveAlphaCheckBox_Checked" Unchecked="CheckboxSettingChanged"
                              ToolTip="Remove alpha channel (--target_type RGB)"/>
                </StackPanel>
            </Expander>

            <!-- 4. MIPMAPS SECTION -->
            <Expander Header="Mipmaps" Style="{StaticResource CompactExpanderStyle}" IsExpanded="True">
                <StackPanel Margin="2,1,0,0">
                    <CheckBox x:Name="GenerateMipmapsCheckBox" Content="Generate Mipmaps" IsChecked="True" Margin="0,0,0,1"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="Enable mipmap generation"/>

                    <CheckBox x:Name="CustomMipmapsCheckBox" Content="Custom Mipmaps (Manual)" IsChecked="False" Margin="0,0,0,2"
                              Checked="CustomMipmapsCheckBox_Changed" Unchecked="CustomMipmapsCheckBox_Changed"
                              ToolTip="Use manual mipmap generation (app-side) instead of automatic (toktx --genmipmap)"/>

                    <!-- MANUAL MIPMAPS SETTINGS (when CustomMipmapsCheckBox is checked) -->
                    <StackPanel x:Name="ManualMipmapsPanel" Visibility="Collapsed">
                        <TextBlock Text="Manual Mip Filter:" Style="{StaticResource LabelStyle}"/>
                        <ComboBox x:Name="MipFilterComboBox"
                                  Style="{StaticResource ReadableComboBoxStyle}"
                                  ItemsSource="{Binding Source={StaticResource FilterTypeValues}}"
                                  SelectionChanged="ComboBoxSettingChanged"
                                  Margin="0,0,0,2"
                                  ToolTip="Filter for manual mipmap generation: Kaiser (best quality), Lanczos3 (sharp), Box (fast), Max/Min (special cases for Toksvig)"/>

                        <CheckBox x:Name="ApplyGammaCorrectionCheckBox" Content="Apply Gamma Correction (sRGB)" IsChecked="True" Margin="0,0,0,1"
                                  Checked="ApplyGammaCorrectionCheckBox_Checked" Unchecked="CheckboxSettingChanged"
                                  ToolTip="Apply gamma 2.2 correction for sRGB textures (albedo, emissive). Disable for linear space (normals, roughness, metallic, AO)"/>

                        <CheckBox x:Name="NormalizeNormalsCheckBox" Content="Normalize Each Mip Level" Margin="0,0,0,2"
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                                  ToolTip="Renormalize normal vectors on each mipmap level during manual generation. Prevents normal vectors from becoming non-unit length after filtering."/>
                    </StackPanel>

                    <!-- AUTOMATIC MIPMAPS SETTINGS (when CustomMipmapsCheckBox is NOT checked) -->
                    <StackPanel x:Name="AutomaticMipmapsPanel" Visibility="Visible">
                        <!-- Mipmap Filter + Wrap Mode (on one row) -->
                        <Grid Margin="0,0,0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="2"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Mip Filter:" Style="{StaticResource LabelStyle}"/>
                                <ComboBox x:Name="ToktxFilterComboBox"
                                          Style="{StaticResource ReadableComboBoxStyle}"
                                          ItemsSource="{Binding Source={StaticResource ToktxFilterTypeValues}}"
                                          SelectionChanged="ComboBoxSettingChanged"
                                          ToolTip="Filter for automatic mipmap generation by toktx (--genmipmap --filter): Kaiser (recommended), Lanczos4 (sharp), Box (fast), Mitchell (balanced)"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Wrap Mode:" Style="{StaticResource LabelStyle}"/>
                                <ComboBox x:Name="WrapModeComboBox"
                                          Style="{StaticResource ReadableComboBoxStyle}"
                                          ItemsSource="{Binding Source={StaticResource WrapModeValues}}"
                                          SelectionChanged="ComboBoxSettingChanged"
                                          ToolTip="Texture sampling mode at edges (--wmode): Clamp (repeat edge pixels, use for most textures) or Wrap (tile/repeat image, use for seamless tiling textures)"/>
                            </StackPanel>
                        </Grid>
                    </StackPanel>

                    <CheckBox x:Name="SaveSeparateMipmapsCheckBox" Content="Save Separate Mipmaps (Debug)" Margin="0,0,0,2"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="Save each mipmap level as separate PNG file for debugging and inspection"/>
                </StackPanel>
            </Expander>

            <!-- 5. NORMAL MAPS SECTION -->
            <Expander Header="Normal Maps" Style="{StaticResource CompactExpanderStyle}" IsExpanded="False">
                <StackPanel Margin="2,1,0,0">
                    <CheckBox x:Name="ConvertToNormalMapCheckBox" Content="Convert: RGB-XYZ â†’ RGBA-XY (2-channel)" Margin="0,0,0,1"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="Convert 3-component normal maps (R=X, G=Y, B=Z) to optimized 2-channel format (RGB=X, A=Y). For 4-channel input, 4th component is ignored. For 2-channel input, optimizes encoding. Only works with automatic mipmaps (toktx --genmipmap --normal_mode)."/>

                    <CheckBox x:Name="NormalizeVectorsCheckBox" Content="Normalize Input Vectors (--normalize)" Margin="0,0,0,1"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="Normalize input normal vectors to unit length before mipmap generation. Use if source normals are not unit length. Only works with automatic mipmaps (toktx --genmipmap --normalize)."/>
                </StackPanel>
            </Expander>

            <!-- 6. TOKSVIG SECTION (For Gloss Maps - requires Custom Mipmaps) -->
            <Expander x:Name="ToksvigExpander" Header="Toksvig (Gloss Anti-Aliasing)" Style="{StaticResource CompactExpanderStyle}" IsExpanded="False">
                <StackPanel Margin="2,1,0,0">
                    <CheckBox x:Name="ToksvigEnabledCheckBox" Content="Enable Toksvig Correction" Margin="0,0,0,2"
                              ToolTip="Apply Toksvig variance-based gloss/roughness adjustment to reduce specular aliasing ('sparkling' artifacts). Requires Custom Mipmaps enabled. Analyzes normal map variance to adjust gloss values."
                              Checked="ToksvigEnabledCheckBox_Changed" Unchecked="ToksvigEnabledCheckBox_Changed"/>

                    <StackPanel x:Name="ToksvigSettingsPanel" IsEnabled="{Binding ElementName=ToksvigEnabledCheckBox, Path=IsChecked}">
                        <TextBlock Text="Calculation Mode:" Style="{StaticResource LabelStyle}"/>
                        <ComboBox x:Name="ToksvigCalculationModeComboBox"
                                  Style="{StaticResource ReadableComboBoxStyle}"
                                  ItemsSource="{Binding Source={StaticResource ToksvigCalculationModeValues}}"
                                  SelectionChanged="ToksvigCalculationModeComboBox_SelectionChanged"
                                  Margin="0,0,0,2"
                                  ToolTip="Classic (3x3 window, GaussianBlur, k^1.5 power) or Simplified (2x2 Box filter, linear k, variance threshold)"/>

                        <TextBlock Text="Composite Power (k) [0.5-8.0]:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2"
                              ToolTip="Weight of variance influence on gloss/roughness adjustment. Higher values = stronger correction. Recommended: 1.0-2.0 for most cases.">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ToksvigCompositePowerSlider" Grid.Column="0"
                                    Minimum="0.5" Maximum="8.0" Value="1.0"
                                    TickFrequency="0.1" IsSnapToTickEnabled="True"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ToksvigCompositePowerSlider, Path=Value, StringFormat={}{0:F1}}"
                                       Width="25" TextAlignment="Right"/>
                        </Grid>

                        <TextBlock Text="Min Mip Level:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2"
                              ToolTip="Minimum mipmap level to start applying Toksvig. 0 = apply to base level (full detail). Higher values = apply only to smaller mipmaps.">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ToksvigMinMipLevelSlider" Grid.Column="0"
                                    Minimum="0" Maximum="5" Value="0"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ToksvigMinMipLevelSlider, Path=Value}"
                                       Width="25" TextAlignment="Right"/>
                        </Grid>

                        <CheckBox x:Name="ToksvigSmoothVarianceCheckBox" Content="Smooth Variance (Classic only)" IsChecked="True"
                                  Margin="0,0,0,2"
                                  ToolTip="Apply 3x3 Gaussian blur to variance map for smoother results. Only available in Classic mode. Reduces noise but may slightly blur the correction."
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"/>

                        <CheckBox x:Name="ToksvigUseEnergyPreservingCheckBox" Content="Energy-Preserving Filtering" IsChecked="True"
                                  Margin="0,0,0,2"
                                  ToolTip="Preserve material energy (alphaÂ² averaging) to prevent specular highlight loss on distant mipmaps. Recommended: keep enabled for physically accurate results."
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"/>

                        <StackPanel x:Name="ToksvigSimplifiedSettingsPanel" Visibility="Collapsed">
                            <TextBlock Text="Variance Threshold (Dead Zone):" Style="{StaticResource LabelStyle}"/>
                            <Grid Margin="0,0,0,2"
                                  ToolTip="Variance below this threshold is set to 0 (dead zone). Reduces noise from low-variance areas. Only for Simplified mode. Recommended: 0.001-0.005">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="ToksvigVarianceThresholdSlider" Grid.Column="0"
                                        Minimum="0" Maximum="0.01" Value="0.002"
                                        TickFrequency="0.0001" SmallChange="0.0001"
                                        Margin="0,0,2,0"
                                        ValueChanged="Slider_ValueChanged"/>
                                <TextBlock Grid.Column="1" Text="{Binding ElementName=ToksvigVarianceThresholdSlider, Path=Value, StringFormat={}{0:F4}}"
                                           Width="40" TextAlignment="Right"/>
                            </Grid>
                        </StackPanel>

                        <CheckBox x:Name="RemoveTemporalMipmapsCheckBox" Content="Keep Temporal Mipmaps (Debug)" Margin="0,0,0,2"
                                  IsChecked="False"
                                  ToolTip="Keep temporary mipmap PNG files after processing for debugging. Useful to visually inspect Toksvig effect on each mip level."
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"/>

                        <TextBlock Text="Normal Map Path:" Style="{StaticResource LabelStyle}"/>
                        <TextBlock x:Name="NormalMapStatusTextBlock" Text="(auto-detect from filename)"
                                   Foreground="Gray" Margin="0,0,0,1" TextWrapping="Wrap"
                                   ToolTip="Status of normal map auto-detection"/>
                        <Grid Margin="0,0,0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="NormalMapPathTextBox" Grid.Column="0"
                                     Margin="0,0,1,0" Height="20"
                                     ToolTip="Path to corresponding normal map. Leave empty for auto-detection from filename patterns (_normal, _nrm, etc.)"
                                     TextChanged="NormalMapPathTextBox_TextChanged"/>
                            <Button Content="..." Grid.Column="1" Width="22" Height="20"
                                    Click="BrowseNormalMap_Click"
                                    ToolTip="Browse and select normal map file"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- 7. HISTOGRAM ANALYSIS SECTION -->
            <Expander Header="Histogram Analysis (Metadata)" Style="{StaticResource CompactExpanderStyle}" IsExpanded="False">
                <StackPanel Margin="2,1,0,0">
                    <CheckBox x:Name="EnableHistogramCheckBox" Content="Enable Histogram Analysis" Margin="0,0,0,2"
                              ToolTip="Analyze texture histogram to compute optimal scale/offset normalization and write metadata to KTX2 for GPU denormalization"
                              Checked="EnableHistogramCheckBox_Changed" Unchecked="EnableHistogramCheckBox_Changed"/>

                    <StackPanel x:Name="HistogramSettingsPanel" IsEnabled="{Binding ElementName=EnableHistogramCheckBox, Path=IsChecked}">
                        <TextBlock Text="Analysis Mode:" Style="{StaticResource LabelStyle}"/>
                        <ComboBox x:Name="HistogramModeComboBox"
                                  Style="{StaticResource ReadableComboBoxStyle}"
                                  ItemsSource="{Binding Source={StaticResource HistogramModeValues}}"
                                  SelectionChanged="ComboBoxSettingChanged"
                                  Margin="0,0,0,2"
                                  ToolTip="Off: disabled, Percentile: robust outlier handling, PercentileWithKnee: smooth outliers (recommended)"/>

                        <!-- Processing Mode ÑƒÐ´Ð°Ð»Ñ‘Ð½ (Ð²ÑÐµÐ³Ð´Ð° Preprocessing) -->

                        <!-- Channel Mode (ÑƒÐ¿Ñ€Ð¾Ñ‰Ñ‘Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ, Quantization Ð²ÑÐµÐ³Ð´Ð° Half16) -->
                        <TextBlock Text="Channel Mode:" Style="{StaticResource LabelStyle}"/>
                        <ComboBox x:Name="HistogramChannelModeComboBox"
                                  Style="{StaticResource ReadableComboBoxStyle}"
                                  ItemsSource="{Binding Source={StaticResource HistogramChannelModeValues}}"
                                  SelectionChanged="ComboBoxSettingChanged"
                                  Margin="0,0,0,2"
                                  ToolTip="AverageLuminance: single scale/offset (recommended), PerChannel: separate RGB scale/offset"/>

                        <TextBlock Text="Percentile Low (%) [0-10]:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2"
                              ToolTip="Lower percentile to ignore dark outliers (e.g., 0.5% = ignore darkest 0.5% pixels)">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="HistogramPercentileLowSlider" Grid.Column="0"
                                    Minimum="0.0" Maximum="10.0" Value="0.5"
                                    TickFrequency="0.1" SmallChange="0.1"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=HistogramPercentileLowSlider, Path=Value, StringFormat={}{0:F1}%}"
                                       Width="35" TextAlignment="Right"/>
                        </Grid>

                        <TextBlock Text="Percentile High (%) [90-100]:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2"
                              ToolTip="Upper percentile to ignore bright outliers (e.g., 99.5% = ignore brightest 0.5% pixels)">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="HistogramPercentileHighSlider" Grid.Column="0"
                                    Minimum="90.0" Maximum="100.0" Value="99.5"
                                    TickFrequency="0.1" SmallChange="0.1"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=HistogramPercentileHighSlider, Path=Value, StringFormat={}{0:F1}%}"
                                       Width="35" TextAlignment="Right"/>
                        </Grid>

                        <TextBlock Text="Knee Width (soft-knee) [0-0.1]:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2"
                              ToolTip="Width of smooth transition region for outliers (0.02 = 2% recommended). Only for PercentileWithKnee mode.">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="HistogramKneeWidthSlider" Grid.Column="0"
                                    Minimum="0.0" Maximum="0.1" Value="0.02"
                                    TickFrequency="0.001" SmallChange="0.001"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=HistogramKneeWidthSlider, Path=Value, StringFormat={}{0:F3}}"
                                       Width="35" TextAlignment="Right"/>
                        </Grid>

                        <TextBlock Text="Min Range Threshold [0-0.1]:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,2"
                              ToolTip="Skip normalization if range too narrow (prevents noise amplification on flat/constant textures)">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="HistogramMinRangeThresholdSlider" Grid.Column="0"
                                    Minimum="0.0" Maximum="0.1" Value="0.01"
                                    TickFrequency="0.001" SmallChange="0.001"
                                    Margin="0,0,2,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=HistogramMinRangeThresholdSlider, Path=Value, StringFormat={}{0:F3}}"
                                       Width="35" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- 8. ACTIONS SECTION -->
            <GroupBox Header="Actions" Style="{StaticResource CompactGroupBoxStyle}">
                <StackPanel>
                    <Button Content="Convert Selected" x:Name="ConvertButton" Height="26" Margin="0,0,0,1"
                            Click="Convert_Click" FontWeight="Bold" Background="#FF4CAF50" Foreground="White"
                            ToolTip="Convert selected texture(s) with current settings"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Content="Apply" x:Name="ApplyButton" Width="50" Margin="0,0,2,0" Click="Apply_Click"/>
                        <Button Content="Reset" x:Name="ResetButton" Width="50" Click="Reset_Click"/>
                    </StackPanel>
                </StackPanel>
            </GroupBox>

        </StackPanel>
    </ScrollViewer>
</UserControl>
