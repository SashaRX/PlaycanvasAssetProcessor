<UserControl x:Class="AssetProcessor.Controls.TextureConversionSettingsPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:core="clr-namespace:AssetProcessor.TextureConversion.Core"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="280">

    <UserControl.Resources>
        <!-- Enum Data Providers -->
        <ObjectDataProvider x:Key="CompressionFormatValues" MethodName="GetValues" ObjectType="{x:Type core:CompressionFormat}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:CompressionFormat"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="OutputFormatValues" MethodName="GetValues" ObjectType="{x:Type core:OutputFormat}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:OutputFormat"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="FilterTypeValues" MethodName="GetValues" ObjectType="{x:Type core:FilterType}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:FilterType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="KTX2SupercompressionValues" MethodName="GetValues" ObjectType="{x:Type core:KTX2SupercompressionType}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:KTX2SupercompressionType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <!-- Compact Expander Style -->
        <Style x:Key="CompactExpanderStyle" TargetType="Expander">
            <Setter Property="Margin" Value="0,0,0,3"/>
            <Setter Property="BorderBrush" Value="#BDC3C7"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HeaderTemplate">
                <Setter.Value>
                    <DataTemplate>
                        <TextBlock Text="{Binding}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                    </DataTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Compact GroupBox Style -->
        <Style x:Key="CompactGroupBoxStyle" TargetType="GroupBox">
            <Setter Property="Margin" Value="0,0,0,2"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="BorderBrush" Value="#BDC3C7"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <!-- ComboBox Style -->
        <Style x:Key="ReadableComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Background" Value="#F5F5F5"/>
            <Setter Property="Foreground" Value="#2C3E50"/>
            <Setter Property="BorderBrush" Value="#BDC3C7"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="5,3"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#2C3E50"/>
            <Setter Property="Padding" Value="5,3"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#E3F2FD"/>
                    <Setter Property="Foreground" Value="#0D47A1"/>
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#BBDEFB"/>
                    <Setter Property="Foreground" Value="#0D47A1"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Label Style -->
        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Margin" Value="0,0,0,2"/>
        </Style>
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <StackPanel Margin="2">

            <!-- 1. PRESET SECTION -->
            <GroupBox Header="Preset" Style="{StaticResource CompactGroupBoxStyle}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <ComboBox x:Name="PresetComboBox" Grid.Column="0" Margin="0,0,5,0"
                              Style="{StaticResource ReadableComboBoxStyle}"
                              SelectionChanged="PresetComboBox_SelectionChanged"
                              ToolTip="Select compression preset"/>
                    <Button Content="ðŸ”" Grid.Column="1" Width="30" Margin="0,0,2,0"
                            Click="AutoDetectPreset_Click"
                            ToolTip="Auto-detect preset by filename"/>
                    <Button Content="..." Grid.Column="2" Width="30"
                            Click="ManagePresets_Click"
                            ToolTip="Manage presets"/>
                </Grid>
            </GroupBox>

            <!-- 2. COMPRESSION SETTINGS SECTION -->
            <Expander Header="Compression Settings" Style="{StaticResource CompactExpanderStyle}" IsExpanded="True">
                <StackPanel Margin="5,2,0,0">
                    <!-- Compression Format -->
                    <TextBlock Text="Compression Format:" Style="{StaticResource LabelStyle}"/>
                    <ComboBox x:Name="CompressionFormatComboBox"
                              Style="{StaticResource ReadableComboBoxStyle}"
                              ItemsSource="{Binding Source={StaticResource CompressionFormatValues}}"
                              SelectionChanged="CompressionFormatComboBox_SelectionChanged"
                              Margin="0,0,0,5"/>

                    <!-- Compression Level (ETC1S only) -->
                    <StackPanel x:Name="CompressionLevelPanel" Visibility="Collapsed">
                        <TextBlock Text="Compression Level (0-5):" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="CompressionLevelSlider" Grid.Column="0"
                                    Minimum="0" Maximum="5" Value="1"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,5,0"
                                    ValueChanged="Slider_ValueChanged"
                                    ToolTip="0=fastest, 5=slowest/best"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=CompressionLevelSlider, Path=Value}"
                                       Width="30" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>

                    <!-- Quality (ETC1S) -->
                    <StackPanel x:Name="ETC1SQualityPanel" Visibility="Collapsed">
                        <TextBlock Text="Quality (1-255):" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ETC1SQualitySlider" Grid.Column="0"
                                    Minimum="1" Maximum="255" Value="128"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,5,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ETC1SQualitySlider, Path=Value}"
                                       Width="30" TextAlignment="Right"/>
                        </Grid>
                        <CheckBox x:Name="UseETC1SRDOCheckBox" Content="RDO Optimizer" Margin="0,0,0,5"
                                  IsChecked="True"
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"/>
                    </StackPanel>

                    <!-- Quality (UASTC) -->
                    <StackPanel x:Name="UASTCQualityPanel" Visibility="Collapsed">
                        <TextBlock Text="UASTC Quality (0-4):" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="UASTCQualitySlider" Grid.Column="0"
                                    Minimum="0" Maximum="4" Value="2"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,5,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=UASTCQualitySlider, Path=Value}"
                                       Width="30" TextAlignment="Right"/>
                        </Grid>
                        <CheckBox x:Name="UseUASTCRDOCheckBox" Content="Use RDO" Margin="0,0,0,2" IsChecked="True"
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"/>
                        <TextBlock Text="RDO Lambda:" Style="{StaticResource LabelStyle}"
                                   IsEnabled="{Binding ElementName=UseUASTCRDOCheckBox, Path=IsChecked}"/>
                        <Grid Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="UASTCRDOLambdaSlider" Grid.Column="0" Minimum="0.1" Maximum="10" Value="1"
                                    TickFrequency="0.1" IsSnapToTickEnabled="True" Margin="0,0,5,0"
                                    ValueChanged="Slider_ValueChanged"
                                    IsEnabled="{Binding ElementName=UseUASTCRDOCheckBox, Path=IsChecked}"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=UASTCRDOLambdaSlider, Path=Value, StringFormat={}{0:F1}}"
                                       Width="40" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>

                    <CheckBox x:Name="PerceptualModeCheckBox" Content="Perceptual Mode" Margin="0,0,0,5" IsChecked="True"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="Visual quality improvement (ETC1S/ASTC only)"/>

                    <!-- Output Format -->
                    <TextBlock Text="Output Format:" Style="{StaticResource LabelStyle}"/>
                    <ComboBox x:Name="OutputFormatComboBox"
                              Style="{StaticResource ReadableComboBoxStyle}"
                              ItemsSource="{Binding Source={StaticResource OutputFormatValues}}"
                              SelectionChanged="OutputFormatComboBox_SelectionChanged"
                              Margin="0,0,0,5"/>

                    <!-- KTX2 Supercompression -->
                    <StackPanel x:Name="KTX2SupercompressionPanel" Visibility="Collapsed">
                        <TextBlock Text="KTX2 Supercompression:" Style="{StaticResource LabelStyle}"/>
                        <ComboBox x:Name="KTX2SupercompressionComboBox"
                                  Style="{StaticResource ReadableComboBoxStyle}"
                                  ItemsSource="{Binding Source={StaticResource KTX2SupercompressionValues}}"
                                  SelectionChanged="KTX2SupercompressionComboBox_SelectionChanged"
                                  Margin="0,0,0,5"/>

                        <TextBlock Text="Supercompression Level (1-22):" Style="{StaticResource LabelStyle}"/>
                        <TextBlock Text="âš  Note: Not available for ETC1S" FontSize="9" Foreground="Orange" Margin="0,0,0,2"/>
                        <Grid Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ZstdLevelSlider" Grid.Column="0"
                                    Minimum="1" Maximum="22" Value="3"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,5,0"
                                    ValueChanged="Slider_ValueChanged"
                                    ToolTip="Zstandard level (default 3). Only for UASTC! Values >20 require more memory."/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ZstdLevelSlider, Path=Value}"
                                       Width="30" TextAlignment="Right"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- 3. ALPHA OPTIONS SECTION -->
            <Expander Header="Alpha Options" Style="{StaticResource CompactExpanderStyle}" IsExpanded="False">
                <StackPanel Margin="5,2,0,0">
                    <CheckBox x:Name="ForceAlphaCheckBox" Content="Force Alpha Channel" Margin="0,0,0,3"
                              Checked="ForceAlphaCheckBox_Checked" Unchecked="CheckboxSettingChanged"
                              ToolTip="Add alpha channel (--target_type RGBA)"/>
                    <CheckBox x:Name="RemoveAlphaCheckBox" Content="Remove Alpha Channel" Margin="0,0,0,3"
                              Checked="RemoveAlphaCheckBox_Checked" Unchecked="CheckboxSettingChanged"
                              ToolTip="Remove alpha channel (--target_type RGB)"/>
                </StackPanel>
            </Expander>

            <!-- 4. COLOR & SPACE SECTION -->
            <Expander Header="Color &amp; Space" Style="{StaticResource CompactExpanderStyle}" IsExpanded="False">
                <StackPanel Margin="5,2,0,0">
                    <TextBlock Text="Color Space (OETF):" Style="{StaticResource LabelStyle}" Margin="0,0,0,2"/>
                    <RadioButton x:Name="OETFAutoRadioButton" Content="Auto (from file)" GroupName="OETF"
                                 IsChecked="True" Margin="0,0,0,2"
                                 Checked="OETFRadioButton_Changed"
                                 ToolTip="Let toktx auto-detect from input file metadata"/>
                    <RadioButton x:Name="OETFLinearRadioButton" Content="Force Linear" GroupName="OETF"
                                 Margin="0,0,0,2"
                                 Checked="OETFRadioButton_Changed"
                                 ToolTip="--assign_oetf linear (for normal maps, roughness, etc.)"/>
                    <RadioButton x:Name="OETFSRGBRadioButton" Content="Force sRGB" GroupName="OETF"
                                 Margin="0,0,0,3"
                                 Checked="OETFRadioButton_Changed"
                                 ToolTip="--assign_oetf srgb (for albedo/color maps)"/>
                </StackPanel>
            </Expander>

            <!-- 5. MIPMAPS SECTION -->
            <Expander Header="Mipmaps" Style="{StaticResource CompactExpanderStyle}" IsExpanded="True">
                <StackPanel Margin="5,2,0,0">
                    <CheckBox x:Name="GenerateMipmapsCheckBox" Content="Generate Mipmaps" IsChecked="True" Margin="0,0,0,5"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="--genmipmap"/>

                    <TextBlock Text="Filter:" Style="{StaticResource LabelStyle}"/>
                    <ComboBox x:Name="MipFilterComboBox"
                              Style="{StaticResource ReadableComboBoxStyle}"
                              ItemsSource="{Binding Source={StaticResource FilterTypeValues}}"
                              SelectionChanged="ComboBoxSettingChanged"
                              Margin="0,0,0,5"
                              ToolTip="--filter"/>

                    <CheckBox x:Name="MipClampCheckBox" Content="Clamp Mip Edges" Margin="0,0,0,3"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="--wmode clamp"/>
                    <CheckBox x:Name="ApplyGammaCorrectionCheckBox" Content="Apply Gamma Correction (sRGB)" IsChecked="True" Margin="0,0,0,3"
                              Checked="ApplyGammaCorrectionCheckBox_Checked" Unchecked="CheckboxSettingChanged"
                              ToolTip="Apply gamma 2.2 for sRGB textures. Disable for linear textures (normals, roughness, etc)"/>
                    <CheckBox x:Name="SaveSeparateMipmapsCheckBox" Content="Save Separate Mipmaps (Debug)" Margin="0,0,0,3"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="Save each mipmap level as separate file for debugging"/>
                </StackPanel>
            </Expander>

            <!-- 6. NORMAL MAPS SECTION -->
            <Expander Header="Normal Maps" Style="{StaticResource CompactExpanderStyle}" IsExpanded="False">
                <StackPanel Margin="5,2,0,0">
                    <CheckBox x:Name="ConvertToNormalMapCheckBox" Content="Convert to XY(RGB/A) Normal Map" Margin="0,0,0,3"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="--normal_mode: 2-channel optimization (RGB=X, A=Y). For 3/4-channel inputs: converts to 2-channel. For 2-channel: optimizes encoding."/>
                    <CheckBox x:Name="NormalizeVectorsCheckBox" Content="Normalize Vectors" Margin="0,0,0,3"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="--normalize: Force normalize normal vectors to unit length"/>
                    <CheckBox x:Name="NormalizeNormalsCheckBox" Content="Normalize Each Mip Level" Margin="0,0,0,3"
                              Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"
                              ToolTip="Renormalize normal vectors on each mipmap level during generation"/>
                </StackPanel>
            </Expander>

            <!-- 7. TOKSVIG SECTION (For Gloss Maps) -->
            <Expander Header="Toksvig (Gloss Anti-Aliasing)" Style="{StaticResource CompactExpanderStyle}" IsExpanded="False">
                <StackPanel Margin="5,2,0,0">
                    <CheckBox x:Name="ToksvigEnabledCheckBox" Content="Enable Toksvig Correction" Margin="0,0,0,5"
                              ToolTip="Apply Toksvig variance-based gloss adjustment for specular anti-aliasing"
                              Checked="ToksvigEnabledCheckBox_Changed" Unchecked="ToksvigEnabledCheckBox_Changed"/>

                    <StackPanel x:Name="ToksvigSettingsPanel" IsEnabled="{Binding ElementName=ToksvigEnabledCheckBox, Path=IsChecked}">
                        <TextBlock Text="Composite Power (k) [0.5-8.0]:" Style="{StaticResource LabelStyle}"
                                   ToolTip="Weight of variance influence on gloss"/>
                        <Grid Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ToksvigCompositePowerSlider" Grid.Column="0"
                                    Minimum="0.5" Maximum="8.0" Value="1.0"
                                    TickFrequency="0.1" IsSnapToTickEnabled="True"
                                    Margin="0,0,5,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ToksvigCompositePowerSlider, Path=Value, StringFormat={}{0:F1}}"
                                       Width="30" TextAlignment="Right"/>
                        </Grid>

                        <TextBlock Text="Min Mip Level:" Style="{StaticResource LabelStyle}"
                                   ToolTip="Minimum mipmap level to apply Toksvig"/>
                        <Grid Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ToksvigMinMipLevelSlider" Grid.Column="0"
                                    Minimum="0" Maximum="5" Value="1"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="0,0,5,0"
                                    ValueChanged="Slider_ValueChanged"/>
                            <TextBlock Grid.Column="1" Text="{Binding ElementName=ToksvigMinMipLevelSlider, Path=Value}"
                                       Width="30" TextAlignment="Right"/>
                        </Grid>

                        <CheckBox x:Name="ToksvigSmoothVarianceCheckBox" Content="Smooth Variance" IsChecked="True"
                                  Margin="0,0,0,5"
                                  ToolTip="Apply 3x3 blur to variance map"
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"/>

                        <CheckBox x:Name="RemoveTemporalMipmapsCheckBox" Content="Keep Temporal Mipmaps (Debug)" Margin="0,0,0,5"
                                  IsChecked="False"
                                  ToolTip="Keep temporary mipmap files to see Toksvig effect"
                                  Checked="CheckboxSettingChanged" Unchecked="CheckboxSettingChanged"/>

                        <TextBlock Text="Normal Map:" Style="{StaticResource LabelStyle}"
                                   ToolTip="Auto-detected or manually specified"/>
                        <TextBlock x:Name="NormalMapStatusTextBlock" Text="(auto-detect from filename)"
                                   FontSize="9" Foreground="Gray" Margin="0,0,0,2"
                                   TextWrapping="Wrap"/>
                        <Grid Margin="0,0,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="NormalMapPathTextBox" Grid.Column="0"
                                     Margin="0,0,2,0" Height="22"
                                     ToolTip="Path to normal map (empty = auto-detect)"
                                     TextChanged="NormalMapPathTextBox_TextChanged"/>
                            <Button Content="..." Grid.Column="1" Width="25" Height="22"
                                    Click="BrowseNormalMap_Click"
                                    ToolTip="Browse for normal map"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- 8. ACTIONS SECTION -->
            <GroupBox Header="Actions" Style="{StaticResource CompactGroupBoxStyle}">
                <StackPanel>
                    <Button Content="âš™ Convert Selected" x:Name="ConvertButton" Height="32" Margin="0,0,0,3"
                            Click="Convert_Click" FontWeight="Bold" Background="#FF4CAF50" Foreground="White"
                            ToolTip="Convert selected texture(s) with current settings"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Content="Apply" x:Name="ApplyButton" Width="60" Margin="0,0,5,0" Click="Apply_Click"/>
                        <Button Content="Reset" x:Name="ResetButton" Width="60" Click="Reset_Click"/>
                    </StackPanel>
                </StackPanel>
            </GroupBox>

        </StackPanel>
    </ScrollViewer>
</UserControl>
