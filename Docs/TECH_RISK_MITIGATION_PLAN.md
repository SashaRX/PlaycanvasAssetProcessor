# План решения технических рисков

Дата: 2026-02-07  
Основание: `Docs/CURRENT_CODE_ANALYSIS.md`

## Цель

Снизить стоимость изменений и риск регрессий за счёт декомпозиции UI-оркестрации, стандартизации асинхронных сценариев и управляемого закрытия техдолга.

## Риски и план действий

### Риск 1. Монолитность `MainWindow` и высокая связность

**Сигнал:** крупный набор `MainWindow.*` partial-файлов, перегруженный конструктор окна, смешение responsibility.

**План (4–6 недель):**
1. Выделить вертикали в отдельные coordinator-классы:
   - `ProjectConnectionCoordinator`
   - `TextureWorkflowCoordinator`
   - `ModelWorkflowCoordinator`
   - `ViewerStateCoordinator`
2. Перенести бизнес-оркестрацию из code-behind в coordinators/services.
3. В `MainWindow` оставить wiring UI-событий + делегирование в команды/координаторы.
4. Сократить DI-конструктор `MainWindow` до минимального набора (VM + 1–2 фасада).

**Критерии готовности:**
- Число зависимостей в конструкторе `MainWindow` сокращено минимум на 40%.
- Для каждой новой vertical-компоненты есть unit-тесты на ключевые сценарии.

---

### Риск 2. Массовый `async void` и сложная диагностика ошибок

**Сигнал:** большое количество `async void` по UI-слою, неочевидные точки падения и отмены.

**План (2–3 недели):**
1. Провести инвентаризацию всех `async void`:
   - оставить только «тонкие» event-handler;
   - внутреннюю логику вынести в `Task`-методы.
2. Ввести единый шаблон выполнения UI-операций:
   - `ExecuteUiActionAsync(Func<CancellationToken, Task>)`;
   - централизованный try/catch + логирование + user-friendly message.
3. Для долгих операций ввести/унифицировать `CancellationToken` и политики отмены.
4. Добавить smoke-набор тестов на отмену/ошибки в критичных workflow.

**Критерии готовности:**
- Все non-event `async void` устранены.
- Ошибки асинхронных операций логируются в едином формате с correlation-id.

---

### Риск 3. Крупные XAML/CS-файлы и низкая модульность UI

**Сигнал:** `MainWindow.xaml` и несколько code-behind файлов 1000+ строк.

**План (3–5 недель):**
1. Разделить `MainWindow.xaml` на UserControl по bounded-context:
   - Assets
   - Materials
   - Texture Preview
   - Model Preview
   - ORM/Batch Tools
2. Вынести повторяемые UI-кусочки в reusable controls + behaviors.
3. Для каждого нового control определить собственный ViewModel (или sub-VM).
4. Добавить UI regression checklist (ручной): фильтры, загрузка, превью, экспорт, ORM-сценарии.

**Критерии готовности:**
- Размер `MainWindow.xaml` сокращён минимум на 50%.
- Основные UI-сценарии проходят по единому регрессионному чеклисту.

---

### Риск 4. Незафиксированный техдолг (TODO в production цепочках)

**Сигнал:** TODO по UV post-processing и toksvig-параметрам в batch-обработке.

**План (1–2 недели):**
1. Создать единый backlog техдолга с owner/priority/due-date.
2. Для каждого TODO определить:
   - целевое поведение,
   - риск невыполнения,
   - минимальный тест-пакет.
3. Закрывать TODO через отдельные небольшие PR (1 риск = 1 PR).
4. Добавить линтер-проверку на новые TODO без ссылки на issue.

**Критерии готовности:**
- Все текущие TODO из критичных pipeline либо закрыты, либо имеют issue и срок.
- Новые TODO без ссылки на issue блокируются на CI.

## Дорожная карта внедрения (по спринтам)

### Спринт 1
- Инвентаризация `MainWindow`-зависимостей и `async void`.
- Создание backlog техдолга.
- Проектирование coordinator-слоя (контракты + DI-схема).

### Спринт 2
- Внедрение 1–2 coordinator (Connection + Texture workflow).
- Рефакторинг критичных async-сценариев на `Task`.
- Первые unit-тесты на orchestration.

### Спринт 3
- Декомпозиция `MainWindow.xaml` на UserControl-блоки.
- Унификация error/cancellation policy.
- Закрытие приоритетных TODO в pipeline.

### Спринт 4
- Доведение покрытия ключевых сценариев.
- Финальный регрессионный прогон.
- Замер KPI, ретроспектива и фиксация новых архитектурных guardrail.

## KPI контроля прогресса

- Средний размер PR по UI-слою (строки/файлы) — тренд на уменьшение.
- Количество баг-фиксов в `MainWindow.*` после релизов — тренд на уменьшение.
- Количество `async void` (кроме event-handler) — 0.
- Время onboarding новой задачи в UI-слое — тренд на уменьшение.
- Количество «висящих» TODO без issue — 0.
