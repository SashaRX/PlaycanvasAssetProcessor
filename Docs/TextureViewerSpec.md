# ТЗ на просмотрщик 2D-текстур

## Цель
Создать быстрый GPU-ориентированный просмотрщик 2D-текстур (PNG, KTX2; впоследствии HDR) с поддержкой корректного выбора уровней мипмапов, фильтрации, sRGB/Linear режимов и грубого контроля экспозиции для HDR.

## Форматы
- **PNG** — декодирование через ImageSharp (пригоден System.Drawing, если доступен GDI+, но предпочтительно ImageSharp).
- **KTX2** — загрузка через `libktx` (P/Invoke) с транскодированием BasisU (ETC1S/UASTC → RGBA8/BGRA8). Требуется загрузка всей mip-цепочки. Из DFD считываем флаг sRGB, размеры, формат и число уровней.
- **HDR (позже)** — Radiance `.hdr` или OpenEXR, пока только заглушка экспозиции без тонмаппинга.

Результат загрузки — структура `TextureData` с размерами, массивом мип-уровней, признаками sRGB и альфы, исходным форматом.

## Графический слой
- Использовать D3D11 (желательно Vortice.Windows) для создания `ID3D11Texture2D` и `ID3D11ShaderResourceView` со всеми мипами.
- Подготовить три `SamplerState`: Point, Linear, Anisotropic (максимальная анизотропия из Caps, пользовательский слайдер).
- Пиксельный шейдер должен поддерживать выбор уровня через `textureLod`, корректировать гамму и применять экспозицию.
- При возможности создавать sRGB SRV; иначе выполнять преобразования в шейдере.

## Состояние просмотра
```
ViewState {
  zoom: float (0.125 … 16.0),
  pan: vec2,
  mipMode: Auto | Fixed,
  mipIndex: int,
  filter: Point | Linear | Aniso,
  anisoLevel: int,
  srgbSampling: bool,
  hdrExposureEV: float,
}
```

## UX
- **Зум** колесом мыши к курсору, кнопки 100%, Fit, 200%.
- **Панорама** средней кнопкой или Space+ЛКМ; скорость зависит от зума.
- **MIP**: Auto — стандартное семплирование, Fixed — выбор через слайдер и `textureLod` или фиксированный LOD в сэмплере.
- **Фильтрация**: Point, Linear, Aniso (слайдер уровня при Aniso).
- **sRGB/Linear**: тумблер; переключение SRV или шейдерных веток без пересоздания текстуры.
- **HDR экспозиция**: слайдер [-5…+5] EV, доступен только для HDR источников.
- **Пиксельная сетка** при зуме > 1.0 (опционально, по умолчанию выкл.).

## UI
Главное полотно рендера + панель настроек справа:
- Инфо: разрешение, число мипов, формат, SRGB, альфа.
- Контролы зума (Fit/100/200), сброс панорамы.
- Выбор режима мипов и слайдер.
- Фильтры и уровень анизотропии.
- Переключатель sRGB.
- Контрол экспозиции HDR.

Статус-бар: текущий mip, фильтр, зум, UV и RGBA под курсором (по клику/Alt).

## Логика sRGB
- При `isSRGB=true` и `srgbSampling=true` использовать sRGB SRV.
- Если sRGB-view недоступен — применять `pow(color, 2.2)` / `pow(color, 1/2.2)` в шейдере.
- Переключение тумблера не пересоздаёт текстуру, только SRV или шейдерные ветки.

## Особенности KTX2
- ETC1S/UASTC → RGBA8/BGRA8, загрузка полной mip-цепочки.
- Чтение DFD для sRGB, размеров, числа мипов.
- Обработка случаев без мипов, NPOT, swizzle каналов.

## Производительность
- Не пересоздавать GPU-ресурсы при изменении зума/панорамы/фильтров/модов мипов.
- Пересоздавать SRV только при смене sRGB режима или фильтра.
- Ограничение на размер текстур (например, 16K) с уведомлением.

## Эджкейс-чеклист
- KTX2 без мипов — скрыть/заблокировать Fixed режим.
- PNG с альфой — непреумноженная визуализация.
- NPOT с мипами — корректное обращение.
- sRGB PNG + Linear toggle — видимая разница.
- Анизотропия актуальна для будущего 3D-просмотра.

## Приёмочные критерии
1. PNG 4K с 10 мипами — мгновенное переключение мипов и фильтров.
2. KTX2 (ETC1S) — корректный sRGB-флаг из DFD, предсказуемая работа Auto/Fixed.
3. sRGB toggle меняет отображение без CPU-пересэмплинга.
4. Зум к курсору, панорама плавная, Fit/100/200 работают мгновенно.
5. HDR файл включает контроль экспозиции без сбоев.
6. UI отзывчив, загрузка GPU выполняется один раз на файл.

## Этапы внедрения
1. **Этап A** — D3D11 рендер-контроль, загрузка PNG, зум/пан, Auto mip с Linear.
2. **Этап B** — SamplerState (Point/Linear/Aniso), Fixed mip через `textureLod`.
3. **Этап C** — KTX2 через libktx, чтение DFD, полная mip-цепочка.
4. **Этап D** — sRGB toggle (SRV или шейдерная эмуляция).
5. **Этап E** — HDR (.hdr), экспозиция EV.
6. **Этап F** — Статус-бар, пипетка, сохранение ViewState.

## Зависимости
- Vortice.Windows (D3D11).
- ImageSharp.
- libktx (BasisU), P/Invoke, x64 бинарь и пути.
