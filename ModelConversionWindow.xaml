<Window x:Class="AssetProcessor.ModelConversionWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AssetProcessor"
        xmlns:core="clr-namespace:AssetProcessor.ModelConversion.Core"
        mc:Ignorable="d"
        Title="Model Conversion Pipeline (FBX → GLB + LOD)"
        Height="800" Width="1400"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <!-- Converters -->
        <local:NullToBoolConverter x:Key="NullToBoolConverter"/>
        <local:InverseBoolConverter x:Key="InverseBoolConverter"/>

        <!-- Enum to ComboBox converter -->
        <ObjectDataProvider x:Key="CompressionModeValues" MethodName="GetValues" ObjectType="{x:Type core:CompressionMode}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:CompressionMode"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="LodLevelValues" MethodName="GetValues" ObjectType="{x:Type core:LodLevel}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="core:LodLevel"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top toolbar -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
            <Button Content="Add FBX Models" Command="{Binding AddModelsCommand}" Width="140" Height="30" Margin="0,0,5,0"/>
            <Button Content="Remove Selected" Command="{Binding RemoveModelCommand}" Width="120" Height="30" Margin="0,0,20,0"/>

            <TextBlock Text="Output Directory:" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <TextBox Text="{Binding OutputDirectory, UpdateSourceTrigger=PropertyChanged}" Width="300" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <Button Content="Browse..." Command="{Binding SelectOutputDirectoryCommand}" Width="80" Height="30" Margin="0,0,20,0"/>

            <TextBlock Text="FBX2glTF:" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <TextBox Text="{Binding Fbx2glTFPath, UpdateSourceTrigger=PropertyChanged}" Width="200" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <Button Content="Browse..." Command="{Binding BrowseFbx2glTFCommand}" Width="80" Height="30" Margin="0,0,10,0"/>

            <TextBlock Text="gltfpack:" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <TextBox Text="{Binding GltfPackPath, UpdateSourceTrigger=PropertyChanged}" Width="150" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <Button Content="Browse..." Command="{Binding BrowseGltfPackCommand}" Width="80" Height="30"/>
        </StackPanel>

        <!-- Main content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="400"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Model list -->
            <GroupBox Grid.Column="0" Header="FBX Models" Margin="0,0,5,0">
                <DataGrid ItemsSource="{Binding Models}"
                          SelectedItem="{Binding SelectedModel}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          SelectionMode="Single">
                    <DataGrid.Columns>
                        <DataGridCheckBoxColumn Header="✓" Binding="{Binding IsEnabled}" Width="30"/>
                        <DataGridTextColumn Header="Model Name" Binding="{Binding ModelName}" Width="250" IsReadOnly="True"/>
                        <DataGridTextColumn Header="LODs" Binding="{Binding ConversionSettings.LodChain.Count}" Width="50" IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>
            </GroupBox>

            <!-- Settings panel -->
            <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="5,0,0,0">
                    <GroupBox Header="Quick Presets" Margin="0,0,0,10">
                        <StackPanel>
                            <TextBlock Text="Apply preset to:" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Button Content="Selected - Default" Command="{Binding ApplyPresetToSelectedCommand}" CommandParameter="Default" Width="150" Margin="0,0,5,0"/>
                                <Button Content="Selected - Production" Command="{Binding ApplyPresetToSelectedCommand}" CommandParameter="Production" Width="150" Margin="0,0,5,0"/>
                                <Button Content="Selected - High Quality" Command="{Binding ApplyPresetToSelectedCommand}" CommandParameter="HighQuality" Width="150" Margin="0,0,5,0"/>
                                <Button Content="Selected - Min Size" Command="{Binding ApplyPresetToSelectedCommand}" CommandParameter="MinSize" Width="150"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <Button Content="All - Default" Command="{Binding ApplyPresetToAllCommand}" CommandParameter="Default" Width="150" Margin="0,0,5,0"/>
                                <Button Content="All - Production" Command="{Binding ApplyPresetToAllCommand}" CommandParameter="Production" Width="150" Margin="0,0,5,0"/>
                                <Button Content="All - High Quality" Command="{Binding ApplyPresetToAllCommand}" CommandParameter="HighQuality" Width="150" Margin="0,0,5,0"/>
                                <Button Content="All - Min Size" Command="{Binding ApplyPresetToAllCommand}" CommandParameter="MinSize" Width="150"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <!-- Model settings (only shown when model is selected) -->
                    <GroupBox Header="Model Settings" IsEnabled="{Binding SelectedModel, Converter={StaticResource NullToBoolConverter}}">
                        <StackPanel DataContext="{Binding SelectedModel.ConversionSettings}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="200"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Generate LODs:" VerticalAlignment="Center" Margin="0,5"/>
                                <CheckBox Grid.Row="0" Grid.Column="1" IsChecked="{Binding GenerateLods}" VerticalAlignment="Center" Margin="0,5"/>

                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Compression Mode:" VerticalAlignment="Center" Margin="0,5"/>
                                <ComboBox Grid.Row="1" Grid.Column="1" ItemsSource="{Binding Source={StaticResource CompressionModeValues}}"
                                          SelectedItem="{Binding CompressionMode}" Margin="0,5"/>

                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Generate Both Tracks:" VerticalAlignment="Center" Margin="0,5"/>
                                <CheckBox Grid.Row="2" Grid.Column="1" IsChecked="{Binding GenerateBothTracks}" VerticalAlignment="Center" Margin="0,5"
                                          ToolTip="Generate both dist/glb (quantization) and dist/meshopt (EXT_meshopt_compression) tracks"/>

                                <TextBlock Grid.Row="3" Grid.Column="0" Text="LOD Hysteresis:" VerticalAlignment="Center" Margin="0,5"/>
                                <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding LodHysteresis}" Margin="0,5"
                                         ToolTip="Hysteresis factor for LOD switching (0.01 - 0.1, default: 0.02)"/>

                                <TextBlock Grid.Row="4" Grid.Column="0" Text="Cleanup Intermediate Files:" VerticalAlignment="Center" Margin="0,5"/>
                                <CheckBox Grid.Row="4" Grid.Column="1" IsChecked="{Binding CleanupIntermediateFiles}" VerticalAlignment="Center" Margin="0,5"/>

                                <TextBlock Grid.Row="5" Grid.Column="0" Text="Generate Manifest:" VerticalAlignment="Center" Margin="0,5"/>
                                <CheckBox Grid.Row="5" Grid.Column="1" IsChecked="{Binding GenerateManifest}" VerticalAlignment="Center" Margin="0,5"/>

                                <TextBlock Grid.Row="6" Grid.Column="0" Text="Generate QA Report:" VerticalAlignment="Center" Margin="0,5"/>
                                <CheckBox Grid.Row="6" Grid.Column="1" IsChecked="{Binding GenerateQAReport}" VerticalAlignment="Center" Margin="0,5"/>
                            </Grid>
                        </StackPanel>
                    </GroupBox>

                    <!-- Quantization settings -->
                    <GroupBox Header="Quantization Settings" Margin="0,10,0,0"
                              IsEnabled="{Binding SelectedModel, Converter={StaticResource NullToBoolConverter}}">
                        <Grid DataContext="{Binding SelectedModel.ConversionSettings.Quantization}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="200"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Position Bits:" VerticalAlignment="Center" Margin="0,5"/>
                            <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Margin="0,5">
                                <Slider Value="{Binding PositionBits}" Minimum="8" Maximum="16" Width="200" VerticalAlignment="Center"
                                        TickFrequency="1" IsSnapToTickEnabled="True"/>
                                <TextBlock Text="{Binding PositionBits}" Margin="10,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="TexCoord Bits:" VerticalAlignment="Center" Margin="0,5"/>
                            <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Margin="0,5">
                                <Slider Value="{Binding TexCoordBits}" Minimum="8" Maximum="16" Width="200" VerticalAlignment="Center"
                                        TickFrequency="1" IsSnapToTickEnabled="True"/>
                                <TextBlock Text="{Binding TexCoordBits}" Margin="10,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Normal Bits:" VerticalAlignment="Center" Margin="0,5"/>
                            <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Margin="0,5">
                                <Slider Value="{Binding NormalBits}" Minimum="8" Maximum="16" Width="200" VerticalAlignment="Center"
                                        TickFrequency="1" IsSnapToTickEnabled="True"/>
                                <TextBlock Text="{Binding NormalBits}" Margin="10,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Color Bits:" VerticalAlignment="Center" Margin="0,5"/>
                            <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal" Margin="0,5">
                                <Slider Value="{Binding ColorBits}" Minimum="8" Maximum="16" Width="200" VerticalAlignment="Center"
                                        TickFrequency="1" IsSnapToTickEnabled="True"/>
                                <TextBlock Text="{Binding ColorBits}" Margin="10,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <!-- LOD Chain settings -->
                    <GroupBox Header="LOD Chain Configuration" Margin="0,10,0,0"
                              IsEnabled="{Binding SelectedModel, Converter={StaticResource NullToBoolConverter}}">
                        <StackPanel DataContext="{Binding SelectedModel.ConversionSettings}">
                            <TextBlock Text="Edit LOD levels (default: LOD0=100%, LOD1=60%, LOD2=30%, LOD3=12%):" Margin="0,0,0,10" TextWrapping="Wrap" Foreground="Gray" FontSize="11"/>

                            <ItemsControl ItemsSource="{Binding LodChain}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Expander Header="{Binding Level}" Margin="0,2,0,2" IsExpanded="False">
                                            <Grid Margin="10,5,0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="180"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>

                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Simplification Ratio:" VerticalAlignment="Center" Margin="0,3"/>
                                                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Margin="0,3">
                                                    <Slider Value="{Binding SimplificationRatio}" Minimum="0.05" Maximum="1.0" Width="180" VerticalAlignment="Center"
                                                            TickFrequency="0.05" IsSnapToTickEnabled="True"/>
                                                    <TextBlock Text="{Binding SimplificationRatio, StringFormat={}{0:F2}}" Margin="10,0,0,0" VerticalAlignment="Center"/>
                                                </StackPanel>

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Aggressive Simplification:" VerticalAlignment="Center" Margin="0,3"/>
                                                <CheckBox Grid.Row="1" Grid.Column="1" IsChecked="{Binding AggressiveSimplification}" VerticalAlignment="Center" Margin="0,3"/>

                                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Switch Threshold:" VerticalAlignment="Center" Margin="0,3"/>
                                                <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Margin="0,3">
                                                    <Slider Value="{Binding SwitchThreshold}" Minimum="0.1" Maximum="1.0" Width="180" VerticalAlignment="Center"
                                                            TickFrequency="0.05" IsSnapToTickEnabled="True"/>
                                                    <TextBlock Text="{Binding SwitchThreshold, StringFormat={}{0:F2}}" Margin="10,0,0,0" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Grid>
                                        </Expander>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </GroupBox>

                    <!-- Info about pipeline -->
                    <GroupBox Header="Pipeline Notes" Margin="0,10,0,0">
                        <TextBlock TextWrapping="Wrap" Margin="5">
                            <Run Text="Pipeline: FBX → base GLB (FBX2glTF) → LOD0-LOD3 (gltfpack) → Manifest + QA Report"/>
                            <LineBreak/>
                            <Run Text="• Two tracks: dist/glb (quantization for editors), dist/meshopt (ETC_meshopt_compression for web)" FontSize="10" Foreground="Gray"/>
                            <LineBreak/>
                            <Run Text="• Manifest contains LOD switching rules with hysteresis for PlayCanvas runtime" FontSize="10" Foreground="Gray"/>
                            <LineBreak/>
                            <Run Text="• QA Report validates acceptance criteria (size reduction, triangle counts, bbox consistency)" FontSize="10" Foreground="Gray"/>
                        </TextBlock>
                    </GroupBox>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- Progress -->
        <GroupBox Grid.Row="2" Header="Processing" Margin="0,10,0,0">
            <StackPanel>
                <TextBlock Text="{Binding ProcessingStatus}" Margin="0,0,0,5"/>
                <ProgressBar Height="20" Value="{Binding ProcessingProgress}" Maximum="100"/>
            </StackPanel>
        </GroupBox>

        <!-- Bottom buttons -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button Content="Process Selected" Command="{Binding ProcessSelectedModelCommand}"
                    Width="150" Height="35" Margin="0,0,10,0"
                    IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBoolConverter}}"/>
            <Button Content="Process All Enabled" Command="{Binding ProcessAllModelsCommand}"
                    Width="150" Height="35" Margin="0,0,10,0"
                    IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBoolConverter}}"/>
            <Button Content="Save Settings" Command="{Binding SaveSettingsCommand}" Width="120" Height="35"/>
        </StackPanel>
    </Grid>
</Window>
