<Window x:Class="AssetProcessor.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:behaviors="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:local="clr-namespace:AssetProcessor"
        Title="Settings" Height="420" Width="600" ResizeMode="NoResize"
        Background="{DynamicResource ThemeBackground}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TabControl x:Name="tabControl" Grid.Row="0" Background="{DynamicResource ThemeBackgroundAlt}">
            <TabItem Header="General">
                <GroupBox x:Name="projectsFolderGroup" Header="Projects Folder" Margin="2,0,2,0" VerticalAlignment="Top"
                          ToolTip="Root folder where PlayCanvas projects will be downloaded">
                    <Grid Margin="2">
                        <TextBox x:Name="ProjectsFolderBox" Text="{Binding ProjectsFolder, UpdateSourceTrigger=PropertyChanged}" VerticalContentAlignment="Center" IsReadOnly="True" MinWidth="200" Margin="2"
                                 ToolTip="Current projects folder path"/>
                        <Button Content="Select folder" Click="SelectFolder" AutomationProperties.Name="SelectFolder" HorizontalAlignment="Right" VerticalAlignment="Center" Width="86" Margin="2"
                                ToolTip="Browse for projects folder"/>
                    </Grid>
                </GroupBox>
            </TabItem>

            <TabItem Header="Playcanvas" Background="#FFFF6600">
                <StackPanel>
                    <TextBlock Margin="1,0,1,0" TextAlignment="Center" HorizontalAlignment="Center">
                            <Hyperlink NavigateUri="https://developer.playcanvas.com/user-manual/api/" RequestNavigate="Hyperlink_RequestNavigate">
                                Help
                            </Hyperlink>
                    </TextBlock>

                    <GroupBox Header="Playcanvas:" Background="#7FFF8A3C" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch" BorderBrush="#FFFF8A3C">
                        <StackPanel>
                            <Label Content="Playcanvas API Key:" ToolTip="Get API key from playcanvas.com/account → API Tokens"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <PasswordBox x:Name="PlaycanvasApiKeyPasswordBox"
                                             Grid.Column="0"
                                             Background="#FFD6A27B"
                                             PasswordChanged="PlaycanvasApiKeyPasswordBox_PasswordChanged"
                                             ToolTip="Your PlayCanvas API token for authentication"/>
                                <TextBox x:Name="PlaycanvasApiKeyRevealTextBox"
                                         Grid.Column="0"
                                         Background="#FFD6A27B"
                                         Visibility="Collapsed"
                                         TextChanged="PlaycanvasApiKeyRevealTextBox_TextChanged"
                                         ToolTip="Your PlayCanvas API token for authentication"/>
                                <Button x:Name="ToggleApiKeyVisibilityButton"
                                        Grid.Column="1"
                                        Content="Показать"
                                        Margin="6,0,0,0"
                                        Padding="8,2"
                                        Click="ToggleApiKeyVisibilityButton_Click"/>
                            </Grid>
                            <TextBlock x:Name="ApiKeyVisibilityWarningText"
                                       Margin="0,4,0,0"
                                       FontSize="10"
                                       Foreground="{DynamicResource ThemeForegroundDim}"
                                       Text="Значение ключа скрыто. Нажмите «Показать» для временного просмотра."/>

                            <Label Content="User Name:" />
                            <TextBox x:Name="UsernameTextBox" Background="#FFD6A27B" ToolTip="Usr name in Playcanvas">
                                <behaviors:Interaction.Behaviors>
                                    <local:TextBoxWatermarkBehavior Watermark="Your username on playcanvas"/>
                                </behaviors:Interaction.Behaviors>
                            </TextBox>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Header="Semaphore Limits" Margin="2,4,2,4"
                              ToolTip="Controls concurrent API requests. Higher = faster but may hit rate limits">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                                <TextBlock Text="Get Textures Semaphore Limit:" Margin="10,10,4,4" HorizontalAlignment="Left" VerticalAlignment="Center"
                                           ToolTip="Max concurrent requests for fetching texture metadata"/>
                                <TextBlock x:Name="GetTexturesSemaphoreTextBlock" Width="50" VerticalAlignment="Center" Margin="0,10,4,4"/>
                            </StackPanel>
                            <Slider x:Name="GetTexturesSemaphoreSlider" Minimum="1" Maximum="256" ValueChanged="SemaphoreLimitSlider_ValueChanged" Width="550" Margin="2,2,2,2"
                                    ToolTip="Recommended: 64 for fast connections, 16 for slow/unstable"/>

                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                                <TextBlock Text="Download Semaphore Limit:" Margin="10,10,4,4" VerticalAlignment="Center" HorizontalAlignment="Left"
                                           ToolTip="Max concurrent file downloads"/>
                                <TextBlock x:Name="DownloadSemaphoreTextBlock" Width="50" VerticalAlignment="Center" Margin="0,10,4,4" HorizontalAlignment="Left"/>
                            </StackPanel>
                            <Slider x:Name="DownloadSemaphoreSlider" Minimum="1" Maximum="64" ValueChanged="SemaphoreLimitSlider_ValueChanged" Width="550" Margin="2,2,2,2"
                                    ToolTip="Recommended: 8 for fast connections, 4 for slow/unstable"/>
                        </StackPanel>
                    </GroupBox>
                </StackPanel>
            </TabItem>

            <TabItem Header="Texture Conversion">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <GroupBox Header="KTX-Software Tool" Margin="0,0,0,6">
                            <StackPanel Margin="2">
                                <TextBlock Text="Leave empty to use from PATH" Margin="0,0,0,4" FontSize="10" Foreground="{DynamicResource ThemeForegroundDim}"/>

                                <!-- ktx -->
                                <TextBlock Text="ktx:" Margin="0,0,0,2" FontWeight="SemiBold" FontSize="10"/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="70"/>
                                        <ColumnDefinition Width="50"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox x:Name="KtxExecutableBox"
                                             Grid.Column="0"
                                             Text="{Binding KtxExecutablePath, UpdateSourceTrigger=PropertyChanged}"
                                             VerticalContentAlignment="Center"
                                             Height="22"
                                             Margin="0,0,4,0"
                                             FontSize="10"
                                             ToolTip="Path to ktx.exe (KTX-Software). Leave empty to use from PATH"/>

                                    <Button Grid.Column="1"
                                            Content="Browse"
                                            Click="SelectKtxExecutable"
                                            Height="22"
                                            Margin="0,0,4,0"
                                            FontSize="10"/>

                                    <Button Grid.Column="2"
                                            Content="Test"
                                            Click="TestKtx_Click"
                                            Height="22"
                                            FontSize="10"/>
                                </Grid>
                                <TextBlock x:Name="KtxStatusText" Margin="0,0,0,4" FontSize="9" Foreground="{DynamicResource ThemeForegroundDim}" TextWrapping="Wrap"/>

                                <!-- Installation info -->
                                <TextBlock Text="Install:" Margin="0,2,0,0" FontWeight="SemiBold" FontSize="10"/>
                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,0" FontSize="9">
                                    <Run Text="winget install KhronosGroup.KTX-Software" FontFamily="Consolas"/>
                                    <Run Text=" or download from"/>
                                    <Hyperlink NavigateUri="https://github.com/KhronosGroup/KTX-Software/releases" RequestNavigate="Hyperlink_RequestNavigate">
                                        <Run Text="GitHub"/>
                                    </Hyperlink>
                                </TextBlock>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Performance (Global)" Margin="0,0,0,6">
                            <StackPanel Margin="2">
                                <TextBlock Text="Apply to all conversions" Margin="0,0,0,4" FontSize="10" Foreground="{DynamicResource ThemeForegroundDim}"/>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="D3D11 Viewport:" VerticalAlignment="Center" Margin="0,2" FontSize="10"
                                               ToolTip="Use GPU-accelerated Direct3D 11 texture preview"/>
                                    <CheckBox Grid.Row="0" Grid.Column="1" x:Name="UseD3D11PreviewCheckBox" IsChecked="True" VerticalAlignment="Center" Margin="0,2" Checked="D3D11PreviewCheckBox_Changed" Unchecked="D3D11PreviewCheckBox_Changed"
                                              ToolTip="Enable for faster texture preview with mipmap support"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="SSE4.1:" VerticalAlignment="Center" Margin="0,2" FontSize="10"
                                               ToolTip="Use SSE4.1 SIMD instructions for faster processing"/>
                                    <CheckBox Grid.Row="1" Grid.Column="1" x:Name="UseSSE41CheckBox" IsChecked="{Binding UseSSE41}" VerticalAlignment="Center" Margin="0,2"
                                              ToolTip="Recommended on modern CPUs (2008+)"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="OpenCL:" VerticalAlignment="Center" Margin="0,2" FontSize="10"
                                               ToolTip="Use OpenCL GPU acceleration for compression"/>
                                    <CheckBox Grid.Row="2" Grid.Column="1" x:Name="UseOpenCLCheckBox" IsChecked="{Binding UseOpenCL}" VerticalAlignment="Center" Margin="0,2"
                                              ToolTip="Enable if you have a compatible GPU with OpenCL support"/>

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Multithreading:" VerticalAlignment="Center" Margin="0,2" FontSize="10"
                                               ToolTip="Use multiple CPU threads for parallel processing"/>
                                    <CheckBox Grid.Row="3" Grid.Column="1" x:Name="UseMultithreadingCheckBox" IsChecked="{Binding UseMultithreading}" VerticalAlignment="Center" Margin="0,2"
                                              ToolTip="Recommended for multi-core CPUs"/>

                                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Threads:" VerticalAlignment="Center" Margin="0,2" FontSize="10"/>
                                    <StackPanel Grid.Row="4" Grid.Column="1" Orientation="Horizontal" Margin="0,2">
                                        <Slider x:Name="ThreadCountSlider"
                                                Value="{Binding ThreadCount}"
                                                Minimum="0"
                                                Maximum="32"
                                                Width="160"
                                                TickFrequency="1"
                                                IsSnapToTickEnabled="True"
                                                VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding ElementName=ThreadCountSlider, Path=Value}"
                                                   Margin="6,0,0,0"
                                                   VerticalAlignment="Center"
                                                   Width="20"
                                                   FontSize="10"/>
                                        <TextBlock Text="(0=auto)"
                                                   Margin="3,0,0,0"
                                                   VerticalAlignment="Center"
                                                   FontSize="9"
                                                   Foreground="{DynamicResource ThemeForegroundDim}"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </GroupBox>

                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <TabItem Header="Model Conversion">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <GroupBox Header="Model Conversion Tools" Margin="0,0,0,6">
                            <StackPanel Margin="2">
                                <TextBlock Text="Leave empty to use from PATH" Margin="0,0,0,4" FontSize="10" Foreground="{DynamicResource ThemeForegroundDim}"/>

                                <!-- FBX2glTF -->
                                <TextBlock Text="FBX2glTF:" Margin="0,0,0,2" FontWeight="SemiBold" FontSize="10"/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="70"/>
                                        <ColumnDefinition Width="50"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox x:Name="FBX2glTFExecutableBox"
                                             Grid.Column="0"
                                             Text="{Binding FBX2glTFExecutablePath, UpdateSourceTrigger=PropertyChanged}"
                                             VerticalContentAlignment="Center"
                                             Height="22"
                                             Margin="0,0,4,0"
                                             FontSize="10"
                                             ToolTip="Path to FBX2glTF.exe for FBX to glTF conversion. Leave empty to use from PATH"/>

                                    <Button Grid.Column="1"
                                            Content="Browse"
                                            Click="SelectFBX2glTFExecutable"
                                            Height="22"
                                            Margin="0,0,4,0"
                                            FontSize="10"/>

                                    <Button Grid.Column="2"
                                            Content="Test"
                                            Click="TestFBX2glTF_Click"
                                            Height="22"
                                            FontSize="10"/>
                                </Grid>
                                <TextBlock x:Name="FBX2glTFStatusText" Margin="0,0,0,4" FontSize="9" Foreground="{DynamicResource ThemeForegroundDim}" TextWrapping="Wrap"/>

                                <!-- gltfpack -->
                                <TextBlock Text="gltfpack:" Margin="0,0,0,2" FontWeight="SemiBold" FontSize="10"/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="70"/>
                                        <ColumnDefinition Width="50"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox x:Name="GltfPackExecutableBox"
                                             Grid.Column="0"
                                             Text="{Binding GltfPackExecutablePath, UpdateSourceTrigger=PropertyChanged}"
                                             VerticalContentAlignment="Center"
                                             Height="22"
                                             Margin="0,0,4,0"
                                             FontSize="10"
                                             ToolTip="Path to gltfpack.exe for mesh optimization and LOD generation. Leave empty to use from PATH"/>

                                    <Button Grid.Column="1"
                                            Content="Browse"
                                            Click="SelectGltfPackExecutable"
                                            Height="22"
                                            Margin="0,0,4,0"
                                            FontSize="10"/>

                                    <Button Grid.Column="2"
                                            Content="Test"
                                            Click="TestGltfPack_Click"
                                            Height="22"
                                            FontSize="10"/>
                                </Grid>
                                <TextBlock x:Name="GltfPackStatusText" Margin="0,0,0,4" FontSize="9" Foreground="{DynamicResource ThemeForegroundDim}" TextWrapping="Wrap"/>

                                <!-- Installation info -->
                                <TextBlock Text="Install:" Margin="0,2,0,0" FontWeight="SemiBold" FontSize="10"/>
                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,2" FontSize="9">
                                    <Run Text="FBX2glTF:" FontWeight="SemiBold"/>
                                    <Run Text="Download from"/>
                                    <Hyperlink NavigateUri="https://github.com/godotengine/FBX2glTF" RequestNavigate="Hyperlink_RequestNavigate">
                                        <Run Text="GitHub"/>
                                    </Hyperlink>
                                </TextBlock>
                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,0" FontSize="9">
                                    <Run Text="gltfpack:" FontWeight="SemiBold"/>
                                    <Run Text="Download from"/>
                                    <Hyperlink NavigateUri="https://github.com/zeux/meshoptimizer" RequestNavigate="Hyperlink_RequestNavigate">
                                        <Run Text="GitHub"/>
                                    </Hyperlink>
                                </TextBlock>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <TabItem Header="CDN/Upload" Background="#FF2196F3">
                <StackPanel>
                    <TextBlock Margin="1,0,1,0" TextAlignment="Center" HorizontalAlignment="Center">
                        <Hyperlink NavigateUri="https://www.backblaze.com/docs/cloud-storage-s3-compatible-api" RequestNavigate="Hyperlink_RequestNavigate">
                            Help
                        </Hyperlink>
                    </TextBlock>

                    <GroupBox Header="Backblaze B2:" Background="#7F64B5F6" BorderBrush="#FF2196F3" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch">
                        <StackPanel>
                            <Label Content="Application Key ID:" ToolTip="Get Key ID from Backblaze B2 Console → App Keys"/>
                            <TextBox x:Name="B2KeyIdTextBox" Background="#FFBBDEFB" Foreground="#FF000000"
                                     ToolTip="Application Key ID from B2 Console"/>

                            <Label Content="Application Key:" ToolTip="Application Key (shown only once when created)"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <PasswordBox x:Name="B2ApplicationKeyPasswordBox" Grid.Column="0"
                                             Background="#FFBBDEFB" Foreground="#FF000000"
                                             PasswordChanged="B2ApplicationKeyPasswordBox_PasswordChanged"
                                             ToolTip="Your Backblaze B2 Application Key"/>
                                <TextBox x:Name="B2ApplicationKeyRevealTextBox" Grid.Column="0"
                                         Background="#FFBBDEFB" Foreground="#FF000000"
                                         Visibility="Collapsed"
                                         TextChanged="B2ApplicationKeyRevealTextBox_TextChanged"
                                         ToolTip="Your Backblaze B2 Application Key"/>
                                <Button x:Name="ToggleB2KeyVisibilityButton" Grid.Column="1"
                                        Content="Показать" Margin="6,0,0,0" Padding="8,2"
                                        Click="ToggleB2KeyVisibilityButton_Click"/>
                            </Grid>
                            <TextBlock Margin="0,4,0,0" FontSize="10" Foreground="{DynamicResource ThemeForegroundDim}"
                                       Text="Значение ключа скрыто. Нажмите «Показать» для временного просмотра."/>

                            <Label Content="Bucket Name:"/>
                            <TextBox x:Name="B2BucketNameTextBox" Background="#FFBBDEFB" Foreground="#FF000000"
                                     ToolTip="Name of your B2 bucket"/>

                            <Label Content="Bucket ID (optional):"/>
                            <TextBox x:Name="B2BucketIdTextBox" Background="#FFBBDEFB" Foreground="#FF000000"
                                     ToolTip="Optional. Will be auto-detected if empty"/>

                            <Button x:Name="TestB2ConnectionButton" Content="Test Connection"
                                    HorizontalAlignment="Left" Margin="0,8,0,4" Padding="12,4"
                                    Click="TestB2Connection_Click"/>
                            <TextBlock x:Name="B2ConnectionStatusText" FontSize="10" Foreground="{DynamicResource ThemeForegroundDim}"/>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Header="CDN Settings:" Background="#7F64B5F6" BorderBrush="#FF2196F3"
                              ToolTip="Settings for CDN URL generation">
                        <StackPanel>
                            <Label Content="CDN Base URL:"/>
                            <TextBox x:Name="CdnBaseUrlTextBox" Background="#FFBBDEFB" Foreground="#FF000000"
                                     ToolTip="Public URL for accessing files (e.g., https://cdn.example.com)"/>

                            <Label Content="Path Prefix:"/>
                            <TextBox x:Name="B2PathPrefixTextBox" Background="#FFBBDEFB" Foreground="#FF000000"
                                     ToolTip="Path prefix in bucket (e.g., projects/my-game)"/>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Header="Upload Settings:" Background="#7F64B5F6" BorderBrush="#FF2196F3"
                              ToolTip="Controls upload behavior">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                                <TextBlock Text="Max Concurrent Uploads:" Margin="10,10,4,4" VerticalAlignment="Center"
                                           ToolTip="Max parallel uploads to B2"/>
                                <TextBlock x:Name="B2MaxConcurrentUploadsText" Text="4" Width="50" VerticalAlignment="Center" Margin="0,10,4,4"/>
                            </StackPanel>
                            <Slider x:Name="B2MaxConcurrentUploadsSlider"
                                    Minimum="1" Maximum="16" Value="4"
                                    Width="550" Margin="2,2,2,2"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    ValueChanged="B2MaxConcurrentUploadsSlider_ValueChanged"
                                    ToolTip="Recommended: 4 for most connections"/>

                            <CheckBox x:Name="B2AutoUploadMappingCheckBox" Content="Auto-upload mapping.json"
                                      Margin="10,10,4,4" ToolTip="Automatically upload mapping.json after export"/>
                        </StackPanel>
                    </GroupBox>

                    <TextBlock Text="Note: Application Key is stored encrypted using Windows DPAPI"
                               FontSize="9" Foreground="{DynamicResource ThemeForegroundDim}" Margin="4,4,4,0"/>
                </StackPanel>
            </TabItem>
        </TabControl>

        <!-- Bottom buttons separated from content -->
        <Border Grid.Row="1" BorderThickness="0,1,0,0" BorderBrush="{DynamicResource ThemeBorder}" Background="{DynamicResource ThemeBackgroundAlt}">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="8">
                <Button Content="Save" Click="Save_Click" Padding="16,6" MinWidth="80"/>
                <Button Content="Cancel" Click="Cancel_Click" Padding="16,6" MinWidth="80" Margin="8,0,0,0"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
